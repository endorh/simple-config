buildscript {
    repositories {
        if (!project.hasProperty("forgeGradleBinFolder")) {
            maven {
                url = 'https://files.minecraftforge.net/maven'
            }
        }
        mavenCentral()
    }
    dependencies {
        if (!project.hasProperty("forgeGradleBinFolder")) {
            classpath group: 'net.minecraftforge.gradle', name: 'ForgeGradle', version: '4.+', changing: true
        } else {
            implementation files(project.getProperty("forgeGradleBinFolder").toString())
        }
    }
}

// Plugins
plugins {
    id 'com.github.johnrengelman.shadow' version '6.1.0'
    id 'java'
    id 'maven-publish'
}
apply plugin: 'net.minecraftforge.gradle'
import net.minecraftforge.gradle.common.task.SignJar

// Mod info -----------------------------------------------------------------------

def mod_id = "simple-config"
group = "endorh.simple_config"
version = "0.2.13"
def group_slashed = project.group.replaceAll("\\.", "/"),
    classname = "SimpleConfigMod",
    maven_artifact = "${group}:${mod_id}:${version}"

// Attributes
def display_name = "Simple Config",
    vendor = "Endor H",
    credits = "",
    authors = "Endor H",
    issue_tracker = "",
    page = "",
    update_json = "",
    logo_file = "${mod_id}.png",
    description = '''
Provides an easy way for modders to define config files with autogenerated config GUIs.
Optionally adds a button to the pause menu, which opens the mod list in order to
access mod configs ingame.
'''

// License
def license = "LGPL"

// Dependencies
def mc_version = "1.16.5",
    forge = "36.1.0",
    forge_version = "${mc_version}-${forge}"

//noinspection GroovyUnusedAssignment
def cloth_config_api_version = "4.11.26"

// Jar attributes
archivesBaseName = "${mod_id}-${mc_version}"

def jar_attributes = [
    "Specification-Title"     : "${mod_id}",
    "Specification-Vendor"    : "${vendor}",
    "Specification-Version"   : "1",
    "Implementation-Title"    : project.name,
    "Implementation-Version"  : "${version}",
    "Implementation-Vendor"   : "${vendor}",
    "Implementation-Timestamp": new Date().format("yyyy-MM-dd'T'HH:mm:ssZ"),
    "Maven-Artifact"          : "${maven_artifact}"
]

def mod_properties = [
    modid: mod_id,
    display: display_name,
    version: project.version,
    mcversion: mc_version,
    vendor: vendor,
    authors: authors,
    credits: credits,
    license: license,
    page: page,
    issue_tracker: issue_tracker,
    update_json: update_json,
    logo_file: logo_file,
    description: description,
    group: group,
    class_name: classname,
    group_slashed: group_slashed,

    cloth_config_api_version: cloth_config_api_version
]

// Java options -------------------------------------------------------------------

java.toolchain.languageVersion = JavaLanguageVersion.of(8)

// Unicode support
compileJava.options.encoding = 'UTF-8'
compileTestJava.options.encoding = 'UTF-8'
javadoc.options.encoding = 'UTF-8'

println('Java: ' + System.getProperty('java.version') + ' JVM: ' + System.getProperty('java.vm.version') + '(' + System.getProperty('java.vendor') + ') Arch: ' + System.getProperty('os.arch'))

java {
    withSourcesJar()
}

// Minecraft options --------------------------------------------------------------

minecraft {
    // Mappings:
    // |_Channel__|_Version___|________________________________________
    // | snapshot | YYYYMMDD  | Built nightly
    // | stable   | #         | Built at the discretion of the MCP team
    // | official | MCVersion | From Mojang mapping files
    //
    // Official mappings channel license:
    // https://github.com/MinecraftForge/MCPConfig/blob/master/Mojang.md
    //mappings channel: 'official', version: '1.16.5'
    mappings channel: 'snapshot', version: '20201028-1.16.3'

    // makeObfSourceJar = false // an Srg named sources jar is made by default. uncomment this to disable.
    // accessTransformer = file('src/main/resources/META-INF/accesstransformer.cfg')

    // Run configurations
    runs {
        client {
            //noinspection GroovyAssignabilityCheck
            workingDirectory project.file('run')

            // Allowed flags: SCAN, REGISTRIES, REGISTRYDUMP
            property 'forge.logging.markers', 'REGISTRIES'
            property 'forge.logging.console.level', 'debug'

            mods {
                simpleconfig {
                    //noinspection GroovyAssignabilityCheck
                    source sourceSets.main
                }
            }
        }

        server {
            //noinspection GroovyAssignabilityCheck
            workingDirectory project.file('run')

            // Allowed flags: SCAN, REGISTRIES, REGISTRYDUMP
            property 'forge.logging.markers', 'REGISTRIES'
            property 'forge.logging.console.level', 'debug'

            mods {
                simpleconfig {
                    //noinspection GroovyAssignabilityCheck
                    source sourceSets.main
                }
            }
        }
    }
}

// Include resources generated by data generators.
sourceSets.main.resources { srcDir 'src/generated/resources' }

// Project dependencies -----------------------------------------------------------

repositories {
    maven {
        name = "Cloth Config API"
        url = "https://maven.shedaniel.me/"
    }
    maven {
        url 'https://repo.maven.apache.org/maven2'
        name 'Maven Central'
    }
}

dependencies {
    // IDE
    implementation 'org.jetbrains:annotations:21.0.1'
    implementation 'org.junit.jupiter:junit-jupiter:5.7.2'

    // Minecraft
    minecraft "net.minecraftforge:forge:${forge_version}"

    // Mod dependencies
    // Cloth Config API
    implementation fg.deobf("me.shedaniel.cloth:cloth-config-forge:${cloth_config_api_version}")
}

// Tasks --------------------------------------------------------------------------

shadowJar {
    manifest {
        attributes(jar_attributes)
    }

    // Include only Cloth Config API in the shadow jar
    dependencies {
        //noinspection GroovyAssignabilityCheck
        include dependency(fg.deobf("me.shedaniel.cloth:cloth-config-forge:${cloth_config_api_version}"))
    }

    // Exclude the packages we don't use
    exclude "me/shedaniel/autoconfig/**"
    exclude "me/shedaniel/cloth/**"
    exclude "me/shedaniel/clothconfig/**"
    exclude "me/shedaniel/clothconfig2/forge/**"
    exclude "architectury_inject*/**"

    // Relocate the root package
    relocate "me.shedaniel", "endorh.simple_config.shadowed.me.shedaniel"

    classifier '' // Replace default jar

    // Preferred method to reobfuscate the jar file
    finalizedBy 'reobfJar'
}

reobf {
    shadowJar {}
}

classes.dependsOn extractNatives // Make sure the natives are extracted on compile

// Jar attributes
jar {
    manifest {
        attributes(jar_attributes)
        attributes 'Maven-Artifact': "${maven_artifact}:deobf"
    }

    classifier 'clean'

    // Preferred method to reobfuscate the jar file
    finalizedBy 'reobfJar'
}

artifacts {
    archives shadowJar
}

// Process resources
processResources {
    inputs.properties mod_properties

    // Exclude development files
    exclude("**/.dev/**")
    from(sourceSets.main.resources.srcDirs) {
        filesMatching(["**/*.toml", "**/*.mcmeta"]) {
            expand mod_properties
        }
        filesMatching("**/*.json") {
            if (!getPath().contains("/lang/"))
                expand mod_properties
        }
    }
}

// Publishing
publishing {
    publications {
        mod(MavenPublication) {
            artifact shadowJar
            artifact sourcesJar

            pom {
                name = display_name
                url = page
                properties = [
                    description: description
                ]
            }
        }
    }
    repositories {
        maven {
            name "LocalMods"
            url "${project.projectDir.parentFile.toURI()}maven"
        }
    }
    println "${project.projectDir.parentFile.toURI()}maven"
}

// Jar signing
task signJar(type: SignJar, dependsOn: jar) {
    onlyIf {
        project.hasProperty 'keyStore'
    }
    keyStore = project.findProperty('keyStore')
    alias = project.findProperty('keyStoreAlias')
    storePass = project.findProperty('keyStorePass')
    keyPass = project.findProperty('keyStoreKeyPass')
    inputFile = jar.archiveFile
    outputFile = jar.archiveFile
}
build.dependsOn signJar

task loadKeyInfo {
    onlyIf { return file("keyinfo.properties").exists() }

    doFirst {
        def props = new Properties()
        props.load(new FileReader(file("keyinfo.properties")))

        props.each { key, val ->
            project.ext.set(key, val)
        }

        if (!project.hasProperty('keyStore')) throw new GradleException("Key information file 'keyinfo.properties' does not contain a keyStore variable, unable to continue.")
    }
}
signJar.dependsOn loadKeyInfo
